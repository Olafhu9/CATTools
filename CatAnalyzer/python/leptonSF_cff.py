import FWCore.ParameterSet.Config as cms

def computeAverageSF(set1, lumi1, set2, lumi2):
    sfSet = set1.clone()

    w1 = lumi1/(lumi1+lumi2)
    w2 = lumi2/(lumi1+lumi2)
    for i in range(len(sfSet.values)):
        wv1, wv2 = w1*set1.values[i], w2*set2.values[i]
        we1, we2 = w1*set1.errors[i], w2*set2.errors[i]
        sfSet.values[i] = wv1+wv2
        sfSet.errors[i] = (we1*we1 + we2*we2)**0.5

    return sfSet

def combineSF(set1, set2, additionalUnc1=0, additionalUnc2=0):
    from bisect import bisect_right

    ## build pt bins (x axis)
    binsX1, binsX2 = set1.pt_bins[:], set2.pt_bins[:]
    nbinsX1, nbinsX2 = len(binsX1), len(binsX2)
    binsX = sorted(list(set().union(binsX1, binsX2)))

    ## build (abs) eta bins (y axis)
    isAbsEta1 = hasattr(set1, 'abseta_bins')
    isAbsEta2 = hasattr(set2, 'abseta_bins')
    binNameY, binNameY1, binNameY2 = 'eta_bins', 'eta_bins', 'eta_bins'
    if isAbsEta1: binNameY1 = 'abseta_bins'
    if isAbsEta2: binNameY2 = 'abseta_bins'
    if isAbsEta1 == isAbsEta2 == True: binNameY = 'abseta_bins'

    binsY1 = getattr(set1, binNameY1)[:]
    binsY2 = getattr(set2, binNameY2)[:]
    nbinsY1, nbinsY2 = len(binsY1), len(binsY2)
    if isAbsEta1 == isAbsEta2:
        binsY = sorted(list(set().union(binsY1, binsY2)))
    else:
        print "Expanding bins"
        binsY = sorted(list(set().union(binsY1, [-y for y in binsY1],
                                        binsY2, [-y for y in binsY2])))

    values, errors = [], []
    for y in binsY[:-1]:
        y1, y2 = y, y
        if isAbsEta1 and not isAbsEta2: y1 = abs(y)
        if isAbsEta2 and not isAbsEta1: y2 = abs(y)

        binY1 = bisect_right(binsY1, y1)
        binY2 = bisect_right(binsY2, y2)
        for x in binsX[:-1]:
            binX1 = bisect_right(binsX1, x)
            binX2 = bisect_right(binsX2, x)

            value1, value2, error1, error2 = 1, 1, 0, 0

            if 0 < binX1 < nbinsX1 and 0 < binY1 < nbinsY1:
                bin1 = (binX1-1)+(binY1-1)*(nbinsX1-1)
                value1 = set1.values[bin1]
                error1 = set1.errors[bin1]
            if 0 < binX2 < nbinsX2 and 0 < binY2 < nbinsY2:
                bin2 = (binX2-1)+(binY2-1)*(nbinsX2-1)
                value2 = set2.values[bin2]
                error2 = set2.errors[bin2]

            addErr1 = additionalUnc1*value1
            addErr2 = additionalUnc2*value2

            values.append(value1*value2)
            errors.append((error1**2+error2**2+addErr1**2+addErr2**2)**0.5)

    sfSet = cms.PSet(
        pt_bins = cms.vdouble(binsX),
        values = cms.vdouble(values),
        errors = cms.vdouble(errors),
    )
    setattr(sfSet, binNameY, cms.vdouble(binsY))

    return sfSet

dummySF = cms.PSet(
    pt_bins = cms.vdouble(0,1e9),
    abseta_bins = cms.vdouble(0,1e9),
    eta_bins = cms.vdouble(-1e9,1e9),
    values = cms.vdouble(1.0),
    errors = cms.vdouble(0.0),
)

##Muon SF reference for 2016: https://twiki.cern.ch/twiki/bin/view/CMS/MuonReferenceEffs2016LegacyRereco?rev=11
#Uncertainties are square-summed

#NUM_TightID_DEN_genTracks_eta_pt
muonSFTightId80XLegacyBCDEF  = cms.PSet(
    pt_bins = cms.vdouble(20.0, 25.0, 30.0, 40.0, 50.0, 60.0, 120.0,),
    eta_bins = cms.vdouble(-2.4, -2.3, -2.2, -2.1, -2, -1.7, -1.6, -1.5, -1.4, -1.2, -0.8, -0.5, -0.3, -0.2, 0, 0.2, 0.3, 0.5, 0.8, 1.2, 1.4, 1.5, 1.6, 1.7, 2, 2.1, 2.2, 2.3, 2.4),
    values = cms.vdouble(
      0.9929211, 0.9862565, 0.9869042, 0.98617, 0.9734887, 0.9767436,
      0.987722, 0.9900819, 0.9843185, 0.9925436, 0.979029, 0.9778781,
      0.9652602, 0.9655134, 0.9592343, 0.9607691, 0.9574307, 0.9551105,
      0.9900304, 0.9830378, 0.9802547, 0.9802556, 0.9834641, 0.9989299,
      0.9789371, 0.9837832, 0.9849367, 0.9840951, 0.9830959, 0.9832001,
      0.9883445, 0.9916799, 0.992112, 0.9937712, 0.99285, 0.9849781,
      0.9984558, 0.993523, 0.9945283, 0.9967293, 0.9916448, 1.001904,
      0.9924733, 0.9912323, 0.9933896, 0.9972183, 0.993837, 0.9964774,
      1.004885, 0.9883026, 0.9944297, 0.9964167, 0.9899509, 0.9955699,
      0.9893428, 0.9815887, 0.979369, 0.9785869, 0.9733065, 0.979374,
      1.0133, 0.9980972, 0.9901123, 0.9905211, 0.9878506, 0.9999222,
      1.007244, 0.9896278, 0.9907145, 0.9928279, 0.9906624, 1.007029,
      0.9845405, 0.9788442, 0.970482, 0.9699368, 0.9650449, 0.9668244,
      0.9677617, 0.9885013, 0.9929968, 0.9908882, 0.9868469, 0.9922342,
      0.9933197, 0.9844616, 0.9894449, 0.9913808, 0.9859588, 0.9912908,
      0.9450395, 0.9651323, 0.9560102, 0.9584014, 0.954932, 0.9734326,
      1.008708, 0.9953398, 0.9887929, 0.9878796, 0.9877814, 1.001486,
      1.001182, 0.9955775, 0.9914669, 0.9908779, 0.982875, 0.9892726,
      0.9869313, 0.980383, 0.978876, 0.978512, 0.9776403, 0.9754559,
      1.002562, 0.9995493, 0.9955669, 0.9985001, 0.9876431, 0.9895547,
      1.005706, 1.00055, 0.9978622, 0.9999537, 0.9842155, 1.006261,
      0.9998646, 1.000937, 1.000559, 1.00096, 0.9946984, 1.008389,
      0.995048, 0.9976801, 0.9960572, 0.9993236, 0.9940782, 0.9910102,
      0.9860612, 0.9846567, 0.9866945, 0.9870978, 0.9851159, 0.9792742,
      0.9845759, 0.9829691, 0.9864718, 0.9875258, 0.9862528, 0.9974654,
      0.9789968, 0.9728454, 0.96301, 0.9707886, 0.958312, 0.9576444,
      0.9977249, 0.9894905, 0.9899921, 0.9833168, 0.979228, 0.9864718,
      0.9995535, 0.9689502, 0.978447, 0.9896683, 0.9931878, 0.9977212,
    ),
    errors = cms.vdouble(
      0.0162624,0.008851121,0.008831592,0.009973665,0.01531793,0.03155715,
      0.01614366,0.009330145,0.00715525,0.003795019,0.009639552,0.01980115,
      0.01135307,0.008213911,0.004490876,0.004494928,0.007937248,0.01771312,
      0.01143091,0.006427763,0.003565819,0.00244253,0.007026155,0.01345175,
      0.008124225,0.005229731,0.002788253,0.00292195,0.002729091,0.005162391,
      0.008448084,0.007388617,0.002292193,0.002183107,0.003815488,0.00809659,
      0.01022258,0.005330448,0.003658082,0.002403142,0.00429057,0.01042059,
      0.0135506,0.005728883,0.004140044,0.003438871,0.004221537,0.009253007,
      0.01384143,0.009881927,0.003620239,0.001283766,0.003190118,0.006778233,
      0.01173764,0.007781012,0.005321085,0.001401053,0.002861954,0.007703781,
      0.008354539,0.006920244,0.009855984,0.001738462,0.002854077,0.01520937,
      0.01348383,0.01511897,0.004081218,0.001386873,0.003798152,0.01604107,
      0.02169673,0.0137094,0.008335821,0.003519245,0.008986593,0.02065669,
      0.01875423,0.0132402,0.004670901,0.002283127,0.00406513,0.01395612,
      0.01762874,0.01466033,0.004510965,0.002335587,0.003813854,0.01280894,
      0.02152571,0.01690509,0.01066035,0.003639748,0.008220641,0.02134252,
      0.01592743,0.01282353,0.00434655,0.00187616,0.003797737,0.01644819,
      0.01201567,0.006951748,0.0041583,0.001444052,0.002872506,0.01411253,
      0.01034186,0.005708465,0.004418957,0.001706025,0.002666881,0.008252196,
      0.01253721,0.008299162,0.005510827,0.003347261,0.00456709,0.01205251,
      0.01310182,0.008887448,0.003377138,0.001668591,0.007254765,0.007260569,
      0.01709699,0.009754824,0.004073865,0.004876065,0.006901422,0.01196899,
      0.01366148,0.0105508,0.002911112,0.004240621,0.005893931,0.01454871,
      0.008119916,0.005788309,0.002738503,0.001940431,0.003127286,0.00618855,
      0.01110794,0.007222409,0.002571225,0.003139183,0.0059983,0.0128494,
      0.0122984,0.007374263,0.005808387,0.003403176,0.008136896,0.01558954,
      0.01428466,0.006291871,0.00566781,0.004352177,0.009120908,0.02062255,
      0.01542452,0.008794537,0.01092101,0.00600456,0.01495195,0.03523224,
    ),
)

muonSFTightId80XLegacyGH  = cms.PSet(
    pt_bins = cms.vdouble(20.0, 25.0, 30.0, 40.0, 50.0, 60.0, 120.0,),
    eta_bins = cms.vdouble(-2.4, -2.3, -2.2, -2.1, -2, -1.7, -1.6, -1.5, -1.4, -1.2, -0.8, -0.5, -0.3, -0.2, 0, 0.2, 0.3, 0.5, 0.8, 1.2, 1.4, 1.5, 1.6, 1.7, 2, 2.1, 2.2, 2.3, 2.4),
    values = cms.vdouble(
      0.9733921,0.9829207,0.9788397,0.9786341,0.9783396,0.9690091,
      0.9746167,0.9895371,0.9831718,0.9835097,0.9690168,0.9960027,
      0.9619849,0.9583089,0.9527969,0.9500261,0.9518258,0.9344351,
      0.9714912,0.9786479,0.9792047,0.9795603,0.9794327,0.9703789,
      0.9761653,0.980713,0.9834462,0.9808968,0.9798087,0.9744483,
      1.00636,0.985493,0.9932288,0.9928571,0.990704,0.9805675,
      0.9984465,1.00027,0.995277,1.000081,0.993161,1.00577,
      1.013208,0.9964157,0.9993214,1.000606,0.9971246,0.9891356,
      1.002493,0.9961445,0.9971106,0.9974641,0.9932507,0.9929187,
      0.9833989,0.9862133,0.982244,0.9829573,0.9778676,0.9844244,
      0.989903,0.9967146,0.9924744,0.9944608,0.9903101,0.9931212,
      1.011229,0.9927918,0.9943425,0.9951025,0.9901656,1.005212,
      0.9723523,0.9653478,0.9669938,0.9694937,0.9726016,0.9701784,
      0.9768711,0.9922113,0.995432,0.9966426,0.9910798,0.9948949,
      0.9994132,0.9974312,0.9919411,0.9942013,0.9921438,0.9951441,
      0.9773521,0.9695852,0.9646619,0.9672775,0.970949,0.9803778,
      1.00243,0.9969285,0.99054,0.9922165,0.9905826,0.9976754,
      1.001479,0.9937899,0.9918333,0.9930388,0.9878155,0.9872997,
      0.9838739,0.982351,0.9823809,0.9821099,0.9731001,0.9804397,
      1.004404,0.9991761,1.000435,1.001261,0.985651,1.001036,
      1.009302,1.008606,1.003615,1.002525,0.9852339,1.002316,
      1.009067,0.9922938,1.005089,1.004598,0.9918947,0.9934272,
      1.003372,0.9965033,0.9971745,1.000641,0.9797046,0.981853,
      0.9809895,0.9850132,0.9867957,0.9866508,0.9789762,0.9802217,
      0.9798401,0.9792438,0.982099,0.9833616,0.971947,0.9875323,
      0.975669,0.9692608,0.9616451,0.9630521,0.9574776,0.9557284,
      0.9872915,0.9954791,0.9837539,0.9881284,0.9781359,0.9892497,
      0.9992935,0.9778601,0.9759204,0.9895237,0.9729891,1.000677,
    ),
    errors = cms.vdouble(
      0.01450003,0.01178847,0.01002426,0.008894445,0.0153884,0.03130027,
      0.01302249,0.009728348,0.006013212,0.004279012,0.009144586,0.01833158,
      0.01202487,0.008151546,0.004688478,0.003957309,0.009317232,0.01650016,
      0.01109351,0.005459016,0.003605114,0.002394404,0.007255624,0.01345587,
      0.007909911,0.004645317,0.003127066,0.001241959,0.003236907,0.005667796,
      0.01309411,0.00798145,0.002354068,0.001956119,0.004360996,0.009454777,
      0.01504683,0.01058613,0.003961034,0.00263775,0.004772768,0.01048877,
      0.008685477,0.006549004,0.002993327,0.003337996,0.004792773,0.01212461,
      0.01186266,0.008985474,0.002531777,0.00188827,0.003463421,0.008934572,
      0.01116992,0.007334356,0.00427394,0.001432199,0.002657444,0.005563516,
      0.01239299,0.008046856,0.005271775,0.002156278,0.002414001,0.007126579,
      0.01395003,0.0107767,0.003281058,0.003080653,0.002860271,0.01012005,
      0.01559791,0.01245105,0.005115183,0.00325254,0.008236244,0.01527595,
      0.0141158,0.01022742,0.004242128,0.002233237,0.003652384,0.01058604,
      0.01453707,0.01263258,0.004334137,0.002596901,0.003211136,0.009283452,
      0.01881122,0.01385566,0.00395772,0.003718683,0.007901045,0.01704071,
      0.01675543,0.0103838,0.006460052,0.001561787,0.003121455,0.01050428,
      0.012699,0.01046103,0.003972453,0.001325259,0.00238138,0.008884934,
      0.01133613,0.005763343,0.004306911,0.001837879,0.003111325,0.007774747,
      0.01607563,0.01177393,0.003490825,0.003673074,0.004937863,0.01803022,
      0.009982264,0.003983329,0.005508049,0.001827713,0.007620344,0.01073708,
      0.006085028,0.01490753,0.003713489,0.004506493,0.007860333,0.01779673,
      0.01088877,0.01138233,0.003897282,0.004253106,0.006853437,0.01827021,
      0.01006317,0.002767702,0.00298484,0.001731499,0.003419483,0.006589308,
      0.01036453,0.005776154,0.002586892,0.003323399,0.006691221,0.01329145,
      0.01158454,0.006489649,0.005839065,0.003053805,0.008346156,0.01950703,
      0.01293313,0.007118777,0.006049765,0.004466478,0.009450829,0.01796061,
      0.01574097,0.01146305,0.00857465,0.006705815,0.01261285,0.03105181,
    ),
)


#"NUM_TightRelIso_DEN_TightIDandIPCut_eta_pt" for 2016
muonSFTightIso80XLegacyBCDEF = cms.PSet(
    pt_bins = cms.vdouble(20.0, 25.0, 30.0, 40.0, 50.0, 60.0, 120.0,),
    eta_bins = cms.vdouble(-2.4, -2.3, -2.2, -2.1, -2, -1.7, -1.6, -1.5, -1.4, -1.2, -0.8, -0.5, -0.3, -0.2, 0, 0.2, 0.3, 0.5, 0.8, 1.2, 1.4, 1.5, 1.6, 1.7, 2, 2.1, 2.2, 2.3, 2.4),
    values = cms.vdouble(
      0.9586718,0.9792192,0.9965555,0.9988146,0.9969279,1.000057,
      0.973783,0.9885465,0.9939885,0.998723,0.9966987,0.9949168,
      0.9681262,0.9837785,0.9914557,0.9967602,0.9999892,1.004724,
      0.9906,0.9892111,0.9943195,0.9958888,0.9972717,0.9969587,
      0.9854697,0.989475,0.994831,0.9962059,0.9982132,0.9983756,
      0.9739277,0.9868641,0.9956551,0.99691,0.9965084,1.000722,
      0.9766173,0.9893707,0.9967077,0.9979539,0.9978689,0.9994581,
      0.9855629,0.9901019,0.9951145,0.9971611,0.9969518,0.9993949,
      0.9825059,0.9939871,0.9940657,0.9963782,0.9971932,0.997204,
      0.9898086,0.990048,0.9944945,0.9968842,0.9987257,0.9999276,
      0.9809248,0.9944324,0.9946327,0.9963527,0.9970289,0.9983479,
      0.9775467,0.9916681,0.9928596,0.9958419,0.9967,0.9994132,
      0.9815282,0.9930257,0.9972034,0.9957307,0.9980508,0.9972355,
      0.9748295,0.990657,0.9950902,0.9957307,0.9975538,0.9996565,
      0.9965336,0.997112,0.9962316,0.9959643,0.9977612,0.9976642,
      0.983543,0.9938675,0.9967162,0.9974802,1.000258,0.9982554,
      0.9946498,0.9971363,0.9981198,0.9979606,0.9986335,1.001543,
      0.9948253,1.004674,0.9989983,0.9984509,0.9984363,0.9997924,
      0.984727,1.0037,0.9978114,0.997319,0.9988146,0.999123,
      0.9845009,0.9913493,0.9932402,0.995986,0.998434,0.9993779,
      0.985532,0.985257,0.9929654,0.996196,0.9959674,0.9985224,
      0.9889549,0.9947012,0.9928295,0.9956761,1.000798,0.9987024,
      0.9741477,0.988789,0.9925324,0.9956772,0.9983428,0.9952784,
      0.9790895,0.988588,0.9950029,0.9966657,0.9973457,0.9997032,
      0.9800641,0.9866906,0.9927019,0.9962199,0.9972044,0.997324,
      0.9685085,0.9850848,0.994187,0.9964812,0.9975363,1.001597,
      0.9728987,0.9881536,0.9880551,0.9945047,0.9967024,0.9992022,
      0.9737508,0.9737291,0.9886698,0.9949586,0.9944259,1.003067,
    ),
    errors = cms.vdouble(
      0.01144255,0.00694857,0.002953573,0.002077178,0.003834219,0.005067416,
      0.01080245,0.006816581,0.002388425,0.001647097,0.002994976,0.004065277,
      0.01039099,0.006001595,0.002404264,0.0008459757,0.002522374,0.003413366,
      0.01136036,0.005583104,0.002325727,0.001270149,0.002101509,0.00252078,
      0.005921791,0.003369409,0.001325756,0.0005664497,0.001302877,0.00175029,
      0.009955549,0.006024092,0.002439564,0.001094388,0.001990691,0.002681704,
      0.0104716,0.006233198,0.002349701,0.0009968771,0.002233188,0.002737615,
      0.01216043,0.006685599,0.002568274,0.001221236,0.002575601,0.002588662,
      0.008420513,0.004984166,0.001710551,0.0002495399,0.001472135,0.001941294,
      0.006974564,0.003862637,0.001304392,0.002102912,0.001085662,0.00222182,
      0.008456611,0.004569251,0.001453516,0.0007589697,0.00143854,0.001658457,
      0.01073083,0.005629045,0.001763693,0.0005193468,0.00156445,0.002224657,
      0.01613722,0.008174697,0.002615185,0.001430448,0.002199168,0.002825431,
      0.01092669,0.005329527,0.001816386,0.0009738807,0.001701217,0.002055027,
      0.01130234,0.005325008,0.001962969,0.0009926242,0.001692369,0.002034526,
      0.01714964,0.008198499,0.002575078,0.001265926,0.002488069,0.00282367,
      0.01129161,0.005621072,0.001749881,0.0009220353,0.001618391,0.00215433,
      0.008685726,0.004812475,0.001396098,0.0006309886,0.001282601,0.00156628,
      0.007028845,0.004121164,0.001328921,0.0004385646,0.001044539,0.001348818,
      0.008771378,0.004906054,0.001744199,0.0006072591,0.00152636,0.002000259,
      0.01208444,0.006609129,0.002521992,0.0008142299,0.003013764,0.002746724,
      0.01120464,0.006232451,0.002327427,0.001181786,0.00229175,0.00383312,
      0.01042217,0.006257936,0.002147836,0.001203812,0.002011906,0.002270134,
      0.005933807,0.003459983,0.001335108,0.0007037685,0.00145012,0.001719131,
      0.01085083,0.006065444,0.002367858,0.0007708678,0.002251348,0.003013244,
      0.01032813,0.006191935,0.002301947,0.001127447,0.002425148,0.003789743,
      0.01087796,0.006811154,0.002355113,0.001180097,0.002695375,0.004085599,
      0.01199197,0.007261861,0.002902941,0.001898073,0.009361175,0.004761536,
    ),
)

muonSFTightIso80XLegacyGH = cms.PSet(
    pt_bins = cms.vdouble(20.0, 25.0, 30.0, 40.0, 50.0, 60.0, 120.0,),
    eta_bins = cms.vdouble(-2.4, -2.3, -2.2, -2.1, -2, -1.7, -1.6, -1.5, -1.4, -1.2, -0.8, -0.5, -0.3, -0.2, 0, 0.2, 0.3, 0.5, 0.8, 1.2, 1.4, 1.5, 1.6, 1.7, 2, 2.1, 2.2, 2.3, 2.4),
    values = cms.vdouble(
      0.979682,0.9911308,1.002872,1.000644,1.001579,0.9998993,
      0.9924004,1.003477,1.000261,1.002295,1.00003,0.9964664,
      1.00142,0.9967403,0.9990433,0.9984152,1.000269,1.00229,
      1.006641,0.996553,1.00267,0.9992292,0.99841,0.9962685,
      0.9964708,0.9990571,0.9993325,0.998892,1.000108,0.9997804,
      0.9810016,0.9948262,0.9989362,0.9981932,0.9959667,1.000221,
      0.9904703,0.9918827,0.9992032,0.9991624,0.9995246,0.9973497,
      0.9927506,0.9933258,0.9941319,0.9976103,0.9973681,0.997805,
      0.979088,0.992166,0.9940369,0.9962554,0.9971364,0.9979717,
      0.9910796,0.9919283,0.9949179,0.9968774,0.9984407,0.9994079,
      0.9814728,0.9952383,0.99443,0.9958714,0.9970556,0.9997897,
      0.9714206,0.9898927,0.993153,0.9936641,0.9950855,0.9974252,
      0.9745078,0.9926371,0.9937406,0.9946349,0.99532,0.9966006,
      0.9623186,0.9856479,0.9905834,0.9944346,0.9967009,0.9988653,
      0.9867943,0.994967,0.9905773,0.993983,0.9968571,0.998107,
      0.9819402,0.9915545,0.9914539,0.9957984,0.9986334,0.9967979,
      0.9930509,0.9945,0.9955253,0.996257,0.9976422,1.001313,
      0.9825739,0.9954899,0.9978233,0.9980366,0.9985203,1.000653,
      0.9858811,0.9977544,0.9972849,0.9974411,0.9970006,0.998083,
      0.9823068,0.9895625,0.993334,0.9955634,0.9983125,1.001874,
      0.9894122,0.9851033,0.9922428,0.9962517,0.9980119,1.001375,
      0.991579,0.9934602,0.9939372,0.9968751,1.00085,1.000351,
      0.980756,0.9929711,0.9942377,0.9965445,0.9976012,0.9945912,
      0.9868328,0.9942954,0.9975889,0.998129,0.9985296,1.000496,
      0.9915623,0.9965362,0.9976283,0.9980552,0.9965689,0.9983021,
      0.9910989,0.995655,0.9988142,0.9992011,1.000106,1.005991,
      0.9835189,0.9942316,0.9935472,0.9978175,0.9979348,1.002458,
      0.9868492,0.9873877,0.9919184,0.9978931,0.9963782,1.004818,
    ),
    errors = cms.vdouble(
      0.01124776,0.006983293,0.002861584,0.002091655,0.003611327,0.004915293,
      0.0107867,0.006399225,0.00249031,0.001618944,0.002783359,0.004003285,
      0.009770478,0.005755636,0.002392227,0.0001157969,0.002792977,0.004365861,
      0.009636056,0.005515519,0.002293755,0.001019789,0.002141592,0.002626374,
      0.005811012,0.003459111,0.001381564,0.0005624195,0.001280511,0.001745596,
      0.009999648,0.006136034,0.002368095,0.001128441,0.002033662,0.003442852,
      0.01048407,0.006213763,0.002369404,0.001226751,0.002238469,0.00282172,
      0.01201893,0.006472613,0.002591995,0.001283231,0.002447062,0.002759138,
      0.008936902,0.005092984,0.001748518,0.0005415763,0.001544407,0.001964453,
      0.007119818,0.003915957,0.001317835,0.0005493837,0.001109228,0.002172607,
      0.008712851,0.004586952,0.001479912,0.0007966103,0.001385634,0.001577125,
      0.01089357,0.005744766,0.001765453,0.0005620632,0.00160039,0.002246017,
      0.01646762,0.008506244,0.002719143,0.001504204,0.00248988,0.002867251,
      0.0110134,0.005514371,0.001848017,0.001001887,0.001700962,0.002208043,
      0.01158936,0.005414802,0.001829823,0.0009942426,0.001679594,0.002127313,
      0.01772631,0.008270651,0.002738401,0.001566743,0.002522173,0.002913023,
      0.01170743,0.005754662,0.001733465,0.0009832134,0.001627834,0.002177404,
      0.009025984,0.004976849,0.001411032,0.0007715976,0.001348086,0.001604689,
      0.007121104,0.004277252,0.001370021,0.0004801654,0.001087723,0.001397676,
      0.009065032,0.005034907,0.001728278,0.0002661678,0.001569331,0.001981378,
      0.01184728,0.006840121,0.002577795,0.0008170169,0.001999059,0.002632252,
      0.01190318,0.006343419,0.002374298,0.001189073,0.002251508,0.003734332,
      0.01054646,0.006328203,0.002417765,0.002970118,0.002022392,0.00245222,
      0.005883533,0.003460037,0.001359084,0.0006901562,0.001536377,0.001673833,
      0.01098586,0.006002908,0.002333742,9.831079e-05,0.002123536,0.003001247,
      0.01020839,0.005885301,0.002274234,0.001072629,0.002433333,0.00371325,
      0.01037143,0.007022453,0.002362935,0.001219272,0.002469327,0.003741222,
      0.01209233,0.007258289,0.002962415,0.001711277,0.003920643,0.004237816,
    ),
)

## Electron SF for 2016: https://twiki.cern.ch/twiki/bin/view/CMS/EgammaIDRecipesRun2#94X_series_Fall17V2_Scale_fa_AN1
#Reco is same as '80X Scale factors for 2016 Legacy re-reco'
electronSFReco80XFall17V2 = cms.PSet(
    pt_bins = cms.vdouble(20, 45, 75, 100, 500),
    eta_bins = cms.vdouble(-2.5, -2, -1.566, -1.444, -1, -0.5, 0, 0.5, 1, 1.444, 1.566, 2, 2.5),
    values = cms.vdouble(
      1.016411,1.002128,1.018028,0.9843096,
      0.9979253,0.9969072,1.015416,1,
      0.9907728,0.9622438,1.032895,1.002176,
      0.9917864,0.9918451,1.008114,0.9868819,
      0.9867212,0.9878173,1.005076,0.9939394,
      0.9835898,0.9867617,0.996945,0.9858299,
      0.9835898,0.9867617,0.996945,0.9858299,
      0.9867212,0.9878173,1.005076,0.9939394,
      0.9917864,0.9918451,1.008114,0.9868819,
      0.9907728,0.9622438,1.032895,1.002176,
      0.9979253,0.9969072,1.015416,1,
      1.016411,1.002128,1.018028,0.9843096,
    ),
    errors = cms.vdouble(
      0.003944804,0.006382979,0.01222965,0.01744072,
      0.002744555,0.00449371,0.01068068,0.01015293,
      0.07986844,0.02298519,0.04414654,0.04653625,
      0.002716377,0.005296791,0.005554996,0.006843925,
      0.002502032,0.003516854,0.004652361,0.005802589,
      0.002713591,0.003527598,0.006440484,0.006864706,
      0.002713591,0.003527598,0.006440484,0.006864706,
      0.002502032,0.003516854,0.004652361,0.005802589,
      0.002716377,0.005296791,0.005554996,0.006843925,
      0.07986844,0.02298519,0.04414654,0.04653625,
      0.002744555,0.00449371,0.01068068,0.01015293,
      0.003944804,0.006382979,0.01222965,0.01744072,
    ),
)

electronSFCutBasedTight80XFall17V2 = cms.PSet(
    pt_bins = cms.vdouble(10, 20, 35, 50, 100, 200, 500,),
    eta_bins = cms.vdouble(-2.5, -2, -1.566, -1.444, -0.8, 0, 0.8, 1.444, 1.566, 2, 2.5,),
    values = cms.vdouble(
      1.01995,0.9858906,0.9823529,0.9810811,1.042691,0.9209906,
      0.9912664,0.9871175,0.9849521,0.9873257,0.9952607,1.024447,
      1,1,1,1,1,1,
      1.036458,0.9565972,0.9646393,0.9647979,0.9807923,0.9805936,
      0.9909707,0.9557662,0.9545454,0.9525,0.980117,0.9828572,
      0.9977528,0.9824,0.9810555,0.9759493,1.003554,1.032335,
      1.007772,0.9630932,0.9671429,0.9748677,1.002478,0.9553776,
      1,1,1,1,1,1,
      0.9953704,0.9530745,0.9728997,0.9772152,0.9755245,0.9885714,
      0.965035,0.9425676,0.954023,0.9616402,1.025094,0.9700461,
    ),
    errors = cms.vdouble(
      0.03162507,0.01325478,0.006778618,0.009640511,0.0366422,0.0722922,
      0.02294447,0.01945435,0.007008598,0.004005418,0.01987254,0.08571923,
      1,1,1,1,1,1,
      0.03399027,0.02437604,0.007488027,0.004869467,0.01264785,0.02668792,
      0.02376233,0.02374115,0.004358265,0.009702672,0.01476155,0.02824023,
      0.02356807,0.02374115,0.004358265,0.009702672,0.01476155,0.02859524,
      0.03399027,0.02437604,0.007488027,0.004869467,0.01283388,0.02680238,
      1,1,1,1,1,1,
      0.02294447,0.01945435,0.007008598,0.004005418,0.01987254,0.08571923,
      0.03162507,0.01325478,0.006778618,0.009640511,0.03656184,0.07133162,
    ),
)

electronSFHLTZvtx80X = cms.PSet( #Dummy for 2016
    pt_bins = cms.vdouble(10, 1000,),
    eta_bins = cms.vdouble(-2.5, 2.5,),
    values = cms.vdouble(
        1.0,
        ),
    errors = cms.vdouble(
        0.0, 
        ),
)

#### Trigger SF
#https://twiki.cern.ch/twiki/bin/viewauth/CMS/MuonReferenceEffs2017
#https://twiki.cern.ch/twiki/bin/viewauth/CMS/EgHLTScaleFactorMeasurements on 17Jul2018 re-reco
#pdf: https://indico.cern.ch/event/787358/contributions/3504805/attachments/1883444/3112792/trigger_sf_vgg_HLTEle32_2017_290719.pdf
trigSF_Ele27 = cms.PSet(
    pt_bins = cms.vdouble(35, 50, 70, 100, 150, 200, 500),
    eta_bins = cms.vdouble(-2.5, -2.0, -1.566, -1.4442, -0.8, 0, 0.8, 1.4442, 1.566, 2.0, 2.5),
    values = cms.vdouble(
      0.916, 0.926, 0.901, 0.901, 0.965, 0.951,
      0.901, 0.923, 0.922, 0.928, 0.913, 0.930,
      0.957, 0.980, 0.997, 0.940, 0.934, 0.919,
      0.976, 0.981, 0.982, 0.982, 0.981, 0.974,
      0.993, 0.992, 0.993, 0.987, 0.986, 0.980,
      0.985, 0.984, 0.979, 0.976, 0.980, 0.969,
      0.977, 0.981, 0.979, 0.992, 0.979, 0.978,
      0.959, 0.970, 1.003, 0.974, 0.946, 0.881,
      0.903, 0.926, 0.907, 0.924, 0.904, 0.928,
      0.895, 0.918, 0.909, 0.931, 0.960, 0.897,
    ),
    errors = cms.vdouble(
      0.004, 0.005, 0.019, 0.014, 0.037, 0.054,
      0.003, 0.006, 0.007, 0.009, 0.019, 0.037,
      0.006, 0.020, 0.027, 0.030, 0.055, 0.072,
      0.002, 0.003, 0.004, 0.004, 0.007, 0.008,
      0.002, 0.003, 0.003, 0.004, 0.014, 0.017,
      0.002, 0.003, 0.003, 0.004, 0.014, 0.017,
      0.002, 0.003, 0.004, 0.004, 0.007, 0.008,
      0.006, 0.020, 0.027, 0.031, 0.057, 0.073,
      0.003, 0.006, 0.007, 0.009, 0.018, 0.037,
      0.004, 0.005, 0.019, 0.014, 0.037, 0.052,
    ),
)

trigSF_IsoMu24BCDEF = cms.PSet(
    pt_bins = cms.vdouble(26, 30, 40, 50, 60, 120, 200, 500),
    abseta_bins = cms.vdouble(0.0, 0.9, 1.2, 2.1, 2.4,),
    values = cms.vdouble(
      0.9749304,0.9784002,0.9786019,0.9794716,0.9762392,0.9716374,0.9745907,
      0.9510084,0.9610954,0.9623309,0.9622571,0.9599409,0.9404022,0.9270547,
      0.9813433,0.9946042,0.9967967,0.996425,0.9954728,1.005873,0.9700033,
      0.8999319,0.9412132,0.9530817,0.9549306,0.9439091,0.9720066,0.9034812,
    ),
    errors = cms.vdouble(
      0.0009838972,0.0003229365,0.0002517966,0.0005494611,0.0009877299,0.005781657,0.00859504,
      0.002166569,0.0005666176,0.00037637,0.000796853,0.001296349,0.006503558,0.01990637,
      0.001801851,0.0006077205,0.0004221603,0.0008939979,0.00141612,0.009042724,0.03050656,
      0.00372702,0.00135954,0.001085075,0.002344264,0.003811007,0.03798105,0.2758513,
    ),
)

trigSF_IsoMu24GH = cms.PSet(
    pt_bins = cms.vdouble(26, 30, 40, 50, 60, 120, 200, 500),
    abseta_bins = cms.vdouble(0.0, 0.9, 1.2, 2.1, 2.4,),
    values = cms.vdouble(
      0.9869807,0.9910475,0.9925956,0.9920179,0.9932433,0.9813926,0.9938938,
      0.9628403,0.9718958,0.9746044,0.9753977,0.9709482,0.9544393,0.9771283,
      0.9839196,0.9965498,1.002133,1.00241,1.003164,1.005092,0.9984261,
      0.9138849,0.9486344,0.9629638,0.9670691,0.9627843,0.983115,0.9359486,
    ),
    errors = cms.vdouble(
      0.00103673,0.0003338406,0.0002568499,0.0005595741,0.0008285982,0.004037337,0.009838155,
      0.002332054,0.0005804553,0.0003811936,0.0007663329,0.001531378,0.004843095,0.01465882,
      0.001903168,0.0006317212,0.0004362328,0.0008988669,0.001450984,0.006608388,0.01887067,
      0.004035065,0.001419226,0.001125537,0.002347245,0.003743615,0.02337452,0.06148385,
    ),
)


## Combined Scale factors
muonSFTightId80XLegacy = computeAverageSF(muonSFTightId80XLegacyBCDEF, 19.8, muonSFTightId80XLegacyGH, 16.2)
muonSFTightIso80XLegacy = computeAverageSF(muonSFTightIso80XLegacyBCDEF, 19.8, muonSFTightIso80XLegacyGH, 16.2)
trigSF_IsoMu24 = computeAverageSF(trigSF_IsoMu24BCDEF, 19.8, trigSF_IsoMu24GH, 16.2)
muonSFTight80XLegacy = combineSF(muonSFTightId80XLegacy, muonSFTightIso80XLegacy)
electronSFCutTight80XLegacy = combineSF(electronSFReco80XFall17V2, electronSFCutBasedTight80XFall17V2)
